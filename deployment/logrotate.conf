# Logrotate configuration for AI Research Assistant
# Place this file in /etc/logrotate.d/ai-research-assistant

# Application logs
/var/log/ai-research-assistant/*.log {
    # Rotation frequency
    daily
    
    # Keep 30 days of logs
    rotate 30
    
    # Compress old logs
    compress
    delaycompress
    compresscmd /bin/gzip
    uncompresscmd /bin/gunzip
    compressext .gz
    
    # Don't rotate empty logs
    notifempty
    
    # Handle missing logs gracefully
    missingok
    
    # Create new log files with proper permissions
    create 0644 ai-assistant ai-assistant
    
    # Copy then truncate for active logs
    copytruncate
    
    # Size-based rotation (in addition to daily)
    size 100M
    
    # Date extension for rotated logs
    dateext
    dateformat -%Y%m%d
    
    # Shared scripts for all logs in this directory
    sharedscripts
    
    # Post-rotation script
    postrotate
        # Send SIGUSR1 to the application to reopen log files
        if [ -f /var/run/ai-research-assistant.pid ]; then
            kill -USR1 $(cat /var/run/ai-research-assistant.pid) 2>/dev/null || true
        fi
        
        # Archive old logs to cold storage (optional)
        # find /var/log/ai-research-assistant -name "*.gz" -mtime +30 -exec mv {} /archive/logs/ \;
    endscript
}

# Nginx logs for AI Research Assistant
/var/log/nginx/ai-research-*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    missingok
    create 0640 www-data adm
    sharedscripts
    postrotate
        # Reload nginx to reopen log files
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 $(cat /var/run/nginx.pid) 2>/dev/null || true
        fi
    endscript
}

# Service logs (systemd)
/var/log/ai-research-assistant/service*.log {
    weekly
    rotate 8
    compress
    delaycompress
    notifempty
    missingok
    create 0644 ai-assistant ai-assistant
    size 50M
    copytruncate
}

# Performance and metrics logs
/opt/ai-research-assistant/logs/performance/*.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    missingok
    create 0644 ai-assistant ai-assistant
    
    # Smaller size limit for performance logs
    size 50M
    
    # Archive performance data for analysis
    postrotate
        # Generate daily performance summary
        if [ -x /opt/ai-research-assistant/scripts/summarize_performance.sh ]; then
            /opt/ai-research-assistant/scripts/summarize_performance.sh $(date -d "yesterday" +%Y%m%d)
        fi
    endscript
}

# Model inference logs
/opt/ai-research-assistant/logs/inference/*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    missingok
    create 0644 ai-assistant ai-assistant
    size 100M
    
    # Keep inference logs longer for debugging
    postrotate
        # Archive inference patterns for model improvement
        if [ -x /opt/ai-research-assistant/scripts/analyze_inference.py ]; then
            /opt/ai-research-assistant/venv/bin/python /opt/ai-research-assistant/scripts/analyze_inference.py --date $(date -d "yesterday" +%Y%m%d)
        fi
    endscript
}

# Error logs - keep longer and alert on rotation
/opt/ai-research-assistant/logs/errors/*.log {
    daily
    rotate 60
    compress
    delaycompress
    notifempty
    create 0644 ai-assistant ai-assistant
    size 20M
    
    # Alert on error log rotation (indicates issues)
    postrotate
        # Send alert if error log was rotated (non-empty)
        if [ -s "$1.1" ]; then
            echo "Error log rotated: $1" | mail -s "AI Research Assistant Error Log Alert" ops@yourdomain.com || true
        fi
    endscript
}